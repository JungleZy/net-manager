# 服务器性能监控图表使用指南

## 概述

本指南介绍如何使用基于 ECharts 的服务器性能监控图表功能，实时展示服务器的 CPU、内存、磁盘和网络性能数据。

## 功能特性

### 1. **实时仪表盘**

- **CPU 使用率仪表盘**：半圆形仪表盘，实时显示 CPU 使用率
- **内存使用率仪表盘**：半圆形仪表盘，实时显示内存使用率
- **磁盘使用率仪表盘**：半圆形仪表盘，实时显示磁盘使用率

仪表盘颜色分级：

- 绿色（0-30%）：正常
- 橙色（30-70%）：警告
- 红色（70-100%）：危险

### 2. **网络速率柱状图**

- 展示所有网络接口的上传和下载速率
- 自动将 B/s 转换为 Mbps 显示
- 支持多网口同时展示
- 颜色区分：上传（绿色）、下载（蓝色）

### 3. **历史趋势图**

- **CPU 使用率趋势**：折线图展示 CPU 使用率的历史变化
- **内存使用率趋势**：折线图展示内存使用率的历史变化
- 保留最近 30 个数据点（约 5 分钟的历史数据，10 秒采集一次）
- 平滑曲线展示，带有阴影填充效果

### 4. **动态更新**

- 所有图表随 WebSocket 推送的数据自动更新
- 无需手动刷新
- 实时显示最后更新时间

## 技术实现

### 依赖库

```json
{
  "echarts": "^5.x",
  "vue-echarts": "^7.x"
}
```

### 安装命令

```bash
cd dashboard
npm install echarts vue-echarts --save
```

### 核心组件

**文件路径**: `dashboard/src/views/test/ServerPerformanceTest.vue`

#### 导入 ECharts 组件

```javascript
import VChart from 'vue-echarts'
import { use } from 'echarts/core'
import { GaugeChart, LineChart } from 'echarts/charts'
import {
  TitleComponent,
  TooltipComponent,
  LegendComponent,
  GridComponent
} from 'echarts/components'
import { CanvasRenderer } from 'echarts/renderers'

// 注册ECharts组件
use([
  GaugeChart,
  LineChart,
  TitleComponent,
  TooltipComponent,
  LegendComponent,
  GridComponent,
  CanvasRenderer
])
```

## 图表配置详解

### 1. 仪表盘配置

```javascript
const cpuGaugeOption = computed(() => ({
  series: [
    {
      type: 'gauge',
      startAngle: 180, // 起始角度
      endAngle: 0, // 结束角度（半圆）
      min: 0,
      max: 100,
      splitNumber: 10, // 刻度分段数
      axisLine: {
        lineStyle: {
          width: 6,
          color: [
            [0.3, '#67C23A'], // 0-30% 绿色
            [0.7, '#E6A23C'], // 30-70% 橙色
            [1, '#F56C6C'] // 70-100% 红色
          ]
        }
      },
      detail: {
        valueAnimation: true, // 数值动画
        formatter: '{value}%',
        fontSize: 24
      },
      data: [
        {
          value: performanceData.value?.cpu?.usage_percent || 0,
          name: 'CPU'
        }
      ]
    }
  ]
}))
```

### 2. 网络速率柱状图配置

```javascript
const networkLineOption = computed(() => {
  const interfaces = performanceData.value?.network || []
  const series = []

  // 为每个网口生成上传和下载系列
  interfaces.forEach((iface) => {
    const uploadMbps = bytesToMbps(iface.upload_rate || 0)
    const downloadMbps = bytesToMbps(iface.download_rate || 0)

    series.push(
      {
        name: `${iface.name} 上传`,
        type: 'bar',
        data: [uploadMbps],
        itemStyle: { color: '#67C23A' }
      },
      {
        name: `${iface.name} 下载`,
        type: 'bar',
        data: [downloadMbps],
        itemStyle: { color: '#409EFF' }
      }
    )
  })

  return {
    tooltip: {
      /* 配置 */
    },
    legend: {
      /* 配置 */
    },
    xAxis: {
      /* 配置 */
    },
    yAxis: {
      type: 'value',
      name: 'Mbps',
      axisLabel: {
        formatter: '{value}'
      }
    },
    series: series
  }
})
```

### 3. 趋势折线图配置

```javascript
const cpuTrendOption = computed(() => ({
  tooltip: {
    trigger: 'axis',
    axisPointer: {
      type: 'cross'
    }
  },
  xAxis: {
    type: 'category',
    boundaryGap: false,
    data: timeHistory.value // 时间轴数据
  },
  yAxis: {
    type: 'value',
    name: '使用率(%)',
    min: 0,
    max: 100
  },
  series: [
    {
      name: 'CPU使用率',
      type: 'line',
      smooth: true, // 平滑曲线
      data: cpuHistory.value, // 历史数据
      areaStyle: {
        // 填充区域
        color: 'rgba(64, 158, 255, 0.2)'
      }
    }
  ]
}))
```

## 数据处理

### 速率单位转换

```javascript
// B/s 转换为 Mbps
const bytesToMbps = (bytes) => {
  return Number(((bytes * 8) / 1024 / 1024).toFixed(2))
}
```

**转换公式**：

1. 1 Byte = 8 bits
2. 1 MB = 1024 KB = 1024 \* 1024 Bytes
3. Mbps = (Bytes/s _ 8) / (1024 _ 1024)

### 历史数据管理

```javascript
const MAX_DATA_POINTS = 30
const cpuHistory = ref([])
const memoryHistory = ref([])
const timeHistory = ref([])

const updateHistory = (data) => {
  const now = new Date()
  const timeStr = `${now.getHours()}:${now.getMinutes()}:${now.getSeconds()}`

  // 添加新数据
  cpuHistory.value.push(data.cpu.usage_percent)
  memoryHistory.value.push(data.memory.usage_percent)
  timeHistory.value.push(timeStr)

  // 保持最多30个数据点
  if (cpuHistory.value.length > MAX_DATA_POINTS) {
    cpuHistory.value.shift()
    memoryHistory.value.shift()
    timeHistory.value.shift()
  }
}
```

## WebSocket 数据订阅

```javascript
onMounted(() => {
  subscriptionToken = PubSub.subscribe('server_performance', (msg, data) => {
    console.log('收到服务器性能数据:', data)
    performanceData.value = data
    lastUpdateTime.value = new Date().toLocaleString()
    isConnected.value = true

    // 更新历史数据
    updateHistory(data)
  })
})

onUnmounted(() => {
  if (subscriptionToken) {
    PubSub.unsubscribe(subscriptionToken)
  }
})
```

## 数据格式

### 输入数据格式

```json
{
  "timestamp": 1760710059.59,
  "cpu": {
    "usage_percent": 6.2,
    "cores": 8,
    "physical_cores": 4,
    "per_cpu_percent": [4.5, 6.2, 7.1, 5.8, ...]
  },
  "memory": {
    "usage_percent": 43.9,
    "total": 17179869184,
    "used": 7545806848,
    "available": 9634062336
  },
  "disk": {
    "usage_percent": 79.2,
    "total": 1073741824000,
    "used": 536870912000,
    "free": 536870912000
  },
  "network": [
    {
      "name": "WLAN",
      "ip_address": "192.168.1.100",
      "mac_address": "00:11:22:33:44:55",
      "upload_rate": 260663.09,    // B/s
      "download_rate": 1141350.89, // B/s
      "bytes_sent": 123456789,
      "bytes_recv": 987654321
    }
  ]
}
```

## 使用方法

### 1. 访问页面

在浏览器中访问：

```
http://localhost:5173/#/test/server-performance
```

### 2. 检查连接状态

页面顶部会显示 WebSocket 连接状态：

- **绿色"已连接"**：正常接收数据
- **红色"未连接"**：需要检查服务器和 WebSocket 连接

### 3. 查看实时数据

- 仪表盘会实时更新显示当前使用率
- 网络速率柱状图显示各网口当前速率
- 趋势图显示最近 5 分钟的历史数据

### 4. 交互功能

- **鼠标悬停**：显示详细数值
- **图例点击**：显示/隐藏特定数据系列（网络图表）
- **自动缩放**：图表随窗口大小自动调整

## 性能优化建议

### 1. 数据点限制

```javascript
const MAX_DATA_POINTS = 30 // 限制历史数据点数量
```

- 避免内存占用过大
- 保持图表渲染流畅

### 2. 使用 computed

```javascript
const cpuGaugeOption = computed(() => ({
  // 配置...
}))
```

- 只在依赖数据变化时重新计算
- 提高响应性能

### 3. 图表自动调整

```vue
<v-chart class="chart" :option="cpuGaugeOption" autoresize //
自动响应容器大小变化 />
```

## 自定义配置

### 修改颜色方案

```javascript
axisLine: {
  lineStyle: {
    color: [
      [0.5, '#5470c6'], // 修改为蓝色系
      [0.8, '#91cc75'], // 修改为绿色系
      [1, '#ee6666'] // 修改为红色系
    ]
  }
}
```

### 修改历史数据保留数量

```javascript
const MAX_DATA_POINTS = 60 // 改为60个点（10分钟历史）
```

### 添加新的图表

1. 创建新的图表配置：

```javascript
const newChartOption = computed(() => ({
  // ECharts配置
}))
```

2. 在模板中添加图表：

```vue
<v-chart
  class="chart"
  :option="newChartOption"
  autoresize
  style="height: 300px"
/>
```

## 故障排查

### 问题 1: 图表不显示

**可能原因**：

- ECharts 未正确安装
- 组件未注册

**解决方法**：

```bash
npm install echarts vue-echarts --save
```

### 问题 2: 数据不更新

**可能原因**：

- WebSocket 未连接
- 后端未发送数据

**解决方法**：

1. 检查 WebSocket 连接状态
2. 查看浏览器控制台是否有数据打印
3. 确认后端监控器已启动

### 问题 3: 网络速率显示为 0

**可能原因**：

- 首次采集速率为 0（正常）
- 网卡无流量

**解决方法**：

- 等待至少一个采集周期（10 秒）
- 生成一些网络流量测试

## 扩展建议

1. **添加告警功能**：当使用率超过阈值时发送通知
2. **数据导出**：支持导出历史数据为 CSV
3. **多服务器对比**：同时监控多台服务器
4. **自定义刷新间隔**：允许用户调整数据采集频率
5. **全屏模式**：提供全屏显示选项

## 许可证

本功能遵循项目主许可证。
