# SNMP数据结构说明

## 核心设计原则

### 以switch_id为主键

每个交换机使用`switch_id`作为唯一标识，而不是`ip`地址，因为：
1. ✅ IP地址可能变化
2. ✅ switch_id是数据库主键，唯一且稳定
3. ✅ 便于关联设备信息和接口信息

### 统一存储结构

所有SNMP数据存储在同一个对象中（`snmpData`），每个交换机的数据包含：
- `device_info` - 设备基本信息（10秒更新一次）
- `interface_info` - 接口流量信息（30秒更新一次）

## LocalForage存储结构

### snmpData（主存储）

```javascript
{
    // ========== 交换机 1 ==========
    "1": {
        "switch_id": 1,                    // 交换机ID（主键）
        "ip": "192.168.1.1",               // IP地址
        
        // 设备信息（来自continuous_poller，每10秒更新）
        "device_info": {
            "type": "success",             // 状态：success/error
            "ip": "192.168.1.1",
            "switch_id": 1,
            "snmp_version": "v2c",
            "device_info": {
                "sysDescr": "Cisco IOS Software, C2960 Software...",
                "sysObjectID": "1.3.6.1.4.1.9.1.696",
                "sysUpTime": "12345678",
                "sysContact": "admin@example.com",
                "sysName": "Switch-01",
                "sysLocation": "Server Room"
            },
            "poll_time": 1697520000.123
        },
        
        // 接口信息（来自interface_poller，每30秒更新）
        "interface_info": {
            "type": "success",             // 状态：success/error
            "ip": "192.168.1.1",
            "switch_id": 1,
            "interface_info": [
                {
                    "ifIndex": 1,
                    "ifDescr": "GigabitEthernet0/1",
                    "ifType": 6,
                    "ifMtu": 1500,
                    "ifSpeed": 1000000000,
                    "ifPhysAddress": "00:1a:2b:3c:4d:5e",
                    "ifAdminStatus": 1,
                    "ifOperStatus": 1,
                    "ifInOctets": 123456789,
                    "ifOutOctets": 987654321
                },
                {
                    "ifIndex": 2,
                    "ifDescr": "GigabitEthernet0/2",
                    // ...
                }
            ],
            "interface_count": 24,
            "poll_time": 1697520000.456
        },
        
        // 时间戳
        "device_update_time": "2025-10-17T10:30:00.000Z",      // 设备信息最后更新时间
        "interface_update_time": "2025-10-17T10:30:30.000Z",   // 接口信息最后更新时间
        "last_update_time": "2025-10-17T10:30:30.000Z"         // 最后更新时间（任一）
    },
    
    // ========== 交换机 2 ==========
    "2": {
        "switch_id": 2,
        "ip": "192.168.1.2",
        "device_info": {
            "type": "success",
            // ...
        },
        "interface_info": {
            "type": "error",               // 接口信息获取失败
            "ip": "192.168.1.2",
            "switch_id": 2,
            "error": "SNMP连接超时或配置错误",
            "poll_time": 1697520001.123
        },
        "device_update_time": "2025-10-17T10:30:05.000Z",
        "interface_update_time": null,     // 接口信息获取失败，无更新时间
        "last_update_time": "2025-10-17T10:30:05.000Z"
    },
    
    // ========== 更多交换机 ==========
    "3": { /* ... */ },
    "4": { /* ... */ }
}
```

### snmpSummary（统计信息）

```javascript
{
    "total": 100,                          // 总设备数
    "success": 95,                         // 成功数
    "error": 5,                            // 失败数
    "lastUpdateTime": "2025-10-17T10:30:00.000Z",
    "timestamp": 1697520000000
}
```

## 数据流转过程

### 1. 设备信息更新流程

```mermaid
graph LR
    A[后端continuous_poller] --> B[WebSocket推送]
    B --> C[snmpDeviceUpdate消息]
    C --> D[handleDeviceUpdate]
    D --> E[saveSingleDeviceData]
    E --> F[更新snmpData.device_info]
    F --> G[PubSub发布]
    G --> H[前端组件接收]
```

**详细步骤**:
1. 后端`continuous_poller`轮询设备（10秒间隔）
2. 获取设备信息后立即推送`snmpDeviceUpdate`消息
3. 前端Ws.js接收消息
4. 调用`handleDeviceUpdate`处理
5. 调用`saveSingleDeviceData`保存到LocalForage
6. 使用`switch_id`作为key更新`snmpData`
7. 发布PubSub消息通知订阅者
8. 前端组件接收并更新UI

### 2. 接口信息更新流程

```mermaid
graph LR
    A[后端interface_poller] --> B[WebSocket推送]
    B --> C[snmpInterfaceUpdate消息]
    C --> D[handleInterfaceUpdate]
    D --> E[saveSingleInterfaceData]
    E --> F[更新snmpData.interface_info]
    F --> G[PubSub发布]
    G --> H[前端组件接收]
```

**详细步骤**:
1. 后端`interface_poller`轮询接口（30秒间隔）
2. 获取接口信息后立即推送`snmpInterfaceUpdate`消息
3. 前端Ws.js接收消息
4. 调用`handleInterfaceUpdate`处理
5. 调用`saveSingleInterfaceData`保存到LocalForage
6. 使用`switch_id`作为key更新`snmpData`
7. 发布PubSub消息通知订阅者
8. 前端组件接收并更新UI

## 前端使用示例

### 1. 获取所有交换机数据

```javascript
async getAllSwitches() {
    const snmpData = await localforage.getItem('snmpData') || {};
    return Object.values(snmpData);
}
```

### 2. 获取指定交换机的完整数据

```javascript
async getSwitchData(switchId) {
    const snmpData = await localforage.getItem('snmpData') || {};
    return snmpData[switchId];
}
```

### 3. 获取设备信息

```javascript
async getDeviceInfo(switchId) {
    const snmpData = await localforage.getItem('snmpData') || {};
    return snmpData[switchId]?.device_info;
}
```

### 4. 获取接口信息

```javascript
async getInterfaceInfo(switchId) {
    const snmpData = await localforage.getItem('snmpData') || {};
    return snmpData[switchId]?.interface_info;
}
```

### 5. 检查设备在线状态

```javascript
isDeviceOnline(switchId) {
    const snmpData = await localforage.getItem('snmpData') || {};
    const switchData = snmpData[switchId];
    
    return switchData?.device_info?.type === 'success';
}
```

### 6. 获取在线设备列表

```javascript
async getOnlineSwitches() {
    const snmpData = await localforage.getItem('snmpData') || {};
    
    return Object.values(snmpData).filter(sw => 
        sw.device_info?.type === 'success'
    );
}
```

### 7. 实时更新处理

```javascript
export default {
    data() {
        return {
            switches: {}  // 使用对象存储，key为switch_id
        }
    },
    
    async mounted() {
        // 加载已保存的数据
        this.switches = await localforage.getItem('snmpData') || {};
        
        // 订阅实时更新
        PubSub.subscribe(wsCode.SNMP_DEVICE_UPDATE, (data) => {
            this.handleDeviceUpdate(data);
        });
        
        PubSub.subscribe(wsCode.SNMP_INTERFACE_UPDATE, (data) => {
            this.handleInterfaceUpdate(data);
        });
    },
    
    methods: {
        handleDeviceUpdate(data) {
            const switchId = data.switch_id;
            
            // 如果交换机不存在，初始化
            if (!this.switches[switchId]) {
                this.$set(this.switches, switchId, {
                    switch_id: switchId,
                    ip: data.ip,
                    device_info: null,
                    interface_info: null
                });
            }
            
            // 更新设备信息
            this.$set(this.switches[switchId], 'device_info', data);
            this.$set(this.switches[switchId], 'ip', data.ip);
        },
        
        handleInterfaceUpdate(data) {
            const switchId = data.switch_id;
            
            // 如果交换机不存在，初始化
            if (!this.switches[switchId]) {
                this.$set(this.switches, switchId, {
                    switch_id: switchId,
                    ip: data.ip,
                    device_info: null,
                    interface_info: null
                });
            }
            
            // 更新接口信息
            this.$set(this.switches[switchId], 'interface_info', data);
            this.$set(this.switches[switchId], 'ip', data.ip);
        }
    }
}
```

## 数据状态类型

### type字段说明

#### success（成功）
```javascript
{
    "type": "success",
    "ip": "192.168.1.1",
    "switch_id": 1,
    "device_info": { /* 设备信息 */ }
}
```

#### error（失败）
```javascript
{
    "type": "error",
    "ip": "192.168.1.1",
    "switch_id": 1,
    "error": "SNMP连接超时或配置错误"
}
```

### 处理示例

```javascript
handleUpdate(data) {
    if (data.type === 'success') {
        // 成功：更新数据
        this.updateSwitch(data);
        this.showOnlineStatus(data.switch_id, true);
    } else if (data.type === 'error') {
        // 失败：标记离线
        this.showOnlineStatus(data.switch_id, false);
        this.showError(data.error);
    }
}
```

## 优势总结

### 1. 数据一致性
- ✅ 以switch_id为主键，避免IP变化导致数据混乱
- ✅ 设备信息和接口信息在同一对象中，便于关联查询

### 2. 更新效率
- ✅ 实时推送，不等待批次完成
- ✅ 设备信息和接口信息独立更新，互不干扰
- ✅ 只更新变化的部分，无需全量刷新

### 3. 易于使用
- ✅ 统一的存储结构，简化访问逻辑
- ✅ 清晰的时间戳，便于判断数据新鲜度
- ✅ 完整的错误处理，便于故障排查

### 4. 性能优化
- ✅ LocalForage自动持久化，刷新不丢失
- ✅ 按需读取，减少内存占用
- ✅ 支持高频更新，流畅响应

---

**版本**: 2.0（队列模式）  
**更新时间**: 2025-10-17  
**数据主键**: switch_id  
**存储位置**: LocalForage.snmpData
