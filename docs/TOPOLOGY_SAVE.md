# 拓扑图保存功能说明

## 功能概述

在 Topology.vue 中实现了拓扑图的自动加载和手动保存功能。

## 实现功能

### 1. 自动加载最新拓扑图

页面加载时会自动从后端获取最新保存的拓扑图并渲染：

- 如果存在已保存的拓扑图，则加载并显示
- 如果没有保存的拓扑图，则使用默认的演示数据

### 2. 手动保存拓扑图

点击右下角的"保存"按钮可以保存当前拓扑图：

- **首次保存**：创建新的拓扑图记录
- **再次保存**：更新已有的拓扑图记录
- 保存时显示加载状态，避免重复提交
- 保存成功后显示成功提示

## 新增文件

### 1. topology.js API 文件

**位置**: `dashboard/src/common/api/topology.js`

提供以下 API 方法：

- `createTopology(content)` - 创建拓扑图
- `updateTopology(id, content)` - 更新拓扑图
- `deleteTopology(id)` - 删除拓扑图
- `getTopologiesList()` - 获取所有拓扑图
- `getLatestTopology()` - 获取最新拓扑图
- `getTopologyById(id)` - 根据 ID 获取拓扑图

## 修改文件

### 1. Topology.vue

**新增功能**：

1. **导入模块**：

   - 导入 `TopologyApi` 用于 API 调用
   - 导入 `message` 用于消息提示

2. **状态管理**：

   - `currentTopologyId` - 当前拓扑图的 ID
   - `isSaving` - 保存状态标识

3. **核心方法**：

   - `handleAddNode()` - 保存按钮点击处理
   - `loadLatestTopology()` - 加载最新拓扑图

4. **UI 改进**：
   - 保存按钮显示加载状态
   - 保存中显示"保存中..."文字

## 使用流程

### 用户操作流程

1. **打开拓扑图页面**

   - 系统自动加载最新的拓扑图（如果存在）
   - 如果没有保存过拓扑图，显示默认示例

2. **编辑拓扑图**

   - 从左侧面板拖拽设备/交换机到画布
   - 调整节点位置
   - 连接节点创建拓扑关系

3. **保存拓扑图**
   - 点击右下角"保存"按钮
   - 首次保存会创建新记录
   - 后续保存会更新已有记录
   - 保存成功后显示提示消息

### 数据流程

```
页面加载
  ↓
调用 loadLatestTopology()
  ↓
获取最新拓扑图数据
  ↓
渲染拓扑图
  ↓
用户编辑
  ↓
点击保存按钮
  ↓
调用 handleAddNode()
  ↓
获取当前图形数据 lf.getGraphData()
  ↓
判断是创建还是更新
  ↓
调用对应的API
  ↓
显示保存结果
```

## 保存的数据格式

拓扑图数据格式（GraphData）：

```javascript
{
  "nodes": [
    {
      "id": "节点ID",
      "type": "节点类型（firewall/laptop/pc/router/server/switch）",
      "x": 100,          // X坐标
      "y": 200,          // Y坐标
      "text": "节点文本",
      "properties": {
        "width": 60,
        "height": 60,
        "status": "online/offline",
        "data": {
          "id": "设备ID或交换机ID"
        }
      }
    }
  ],
  "edges": [
    {
      "id": "连线ID",
      "type": "连线类型",
      "sourceNodeId": "源节点ID",
      "targetNodeId": "目标节点ID"
    }
  ]
}
```

## 错误处理

1. **加载失败**：

   - 404 错误（无拓扑图）→ 显示默认数据
   - 其他错误 → 显示默认数据并记录日志

2. **保存失败**：
   - 显示错误提示消息
   - 解除按钮加载状态
   - 记录错误日志

## 注意事项

1. **保存状态**：使用 `isSaving` 防止重复提交
2. **ID 管理**：首次保存后记录 `currentTopologyId`，后续保存使用此 ID
3. **数据验证**：后端会验证 content 是否为有效 JSON
4. **消息提示**：使用 ant-design-vue 的 message 组件显示操作结果

## API 接口说明

详细的 API 接口文档请参考：

- 后端 API 文档：`server/src/network/api/handlers/TOPOLOGY_API.md`

## 测试建议

1. **功能测试**：

   - 测试首次保存（创建）
   - 测试再次保存（更新）
   - 测试页面刷新后数据是否保留
   - 测试保存空拓扑图
   - 测试保存复杂拓扑图

2. **边界测试**：

   - 测试网络错误情况
   - 测试保存超大拓扑图
   - 测试快速连续点击保存按钮

3. **UI 测试**：
   - 验证加载状态显示
   - 验证成功/失败消息提示
   - 验证按钮禁用状态

## 后续扩展

可以考虑的功能增强：

1. **版本管理**：保存拓扑图的多个版本
2. **自动保存**：定时自动保存拓扑图
3. **导入导出**：支持导入/导出拓扑图文件
4. **模板管理**：保存常用拓扑图作为模板
5. **历史记录**：查看和恢复历史版本
