# 服务器性能监控功能

## 概述

服务器性能监控模块定期收集服务器的系统性能数据，包括 CPU、内存、磁盘和网络使用情况，并通过 WebSocket 实时推送到前端进行展示。

## 功能特性

### 监控指标

1. **CPU 信息**

   - CPU 使用率（总体）
   - 每个核心的使用率
   - 逻辑核心数和物理核心数
   - CPU 频率（当前频率、最大频率）
   - CPU 负载（Unix 系统）

2. **内存信息**

   - 内存使用率
   - 总容量、已使用、可用内存
   - 缓存和缓冲区大小
   - 交换分区使用情况

3. **磁盘信息**

   - 磁盘总使用率
   - 各分区的详细信息（设备、挂载点、文件系统类型）
   - 磁盘 IO 统计（读写字节数、读写次数）

4. **网络信息**
   - 每个网络接口的实时上传/下载速率
   - IP 地址、MAC 地址、子网掩码
   - 总发送/接收字节数和包数
   - 自动过滤虚拟接口和回环接口

### 采集频率

默认每 10 秒采集一次性能数据，可在`server/src/core/config.py`中修改`SERVER_MONITOR_INTERVAL`配置项。

## 后端实现

### 核心模块

**文件路径**: `server/src/monitor/server_monitor.py`

```python
from src.monitor import get_server_monitor

# 获取监控器实例（使用配置文件中的间隔）
server_monitor = get_server_monitor()

# 或者显式指定间隔
server_monitor = get_server_monitor(interval=5)

# 启动监控
server_monitor.start()

# 停止监控
server_monitor.stop()
```

### 主要类和方法

#### ServerMonitor 类

- `__init__(interval=None)`: 初始化监控器，设置采集间隔（默认从配置文件读取）
- `start()`: 启动监控线程
- `stop()`: 停止监控线程
- `_collect_performance_data()`: 收集所有性能数据
- `_get_cpu_info()`: 获取 CPU 性能信息
- `_get_memory_info()`: 获取内存使用信息
- `_get_disk_info()`: 获取磁盘使用信息
- `_get_network_info()`: 获取网络接口信息（含速率计算）

### 数据格式

通过 WebSocket 发送的消息格式：

```json
{
  "type": "server_performance",
  "data": {
    "timestamp": 1697520000.123,
    "cpu": {
      "usage_percent": 45.2,
      "cores": 8,
      "physical_cores": 4,
      "current_frequency": 2400.0,
      "load_average": [1.5, 1.2, 1.0],
      "per_cpu_percent": [42.1, 48.3, 43.5, 46.8, 44.2, 47.1, 45.5, 43.9]
    },
    "memory": {
      "total": 17179869184,
      "available": 8589934592,
      "used": 8589934592,
      "free": 4294967296,
      "usage_percent": 50.0,
      "swap_total": 4294967296,
      "swap_used": 0,
      "swap_free": 4294967296,
      "swap_percent": 0.0
    },
    "disk": {
      "total": 1073741824000,
      "used": 536870912000,
      "free": 536870912000,
      "usage_percent": 50.0,
      "partitions": [
        {
          "device": "/dev/sda1",
          "mountpoint": "/",
          "fstype": "ext4",
          "total": 1073741824000,
          "used": 536870912000,
          "free": 536870912000,
          "usage_percent": 50.0
        }
      ],
      "io": {
        "read_bytes": 123456789,
        "write_bytes": 987654321,
        "read_count": 1234,
        "write_count": 5678
      }
    },
    "network": [
      {
        "name": "eth0",
        "ip_address": "192.168.1.100",
        "mac_address": "00:11:22:33:44:55",
        "netmask": "255.255.255.0",
        "bytes_sent": 123456789,
        "bytes_recv": 987654321,
        "packets_sent": 1234,
        "packets_recv": 5678,
        "upload_rate": 1024.5,
        "download_rate": 2048.3
      }
    ]
  },
  "timestamp": 1697520000.123,
  "sequence": 42
}
```

## 前端实现

### WebSocket 处理

**文件路径**: `dashboard/src/common/ws/Ws.js`

WebSocket 消息类型已添加：

```javascript
export const wsCode = {
  // ... 其他类型
  SERVER_PERFORMANCE: 'server_performance' // 服务器性能数据
}
```

在`onmessage`处理中：

```javascript
case "server_performance":
  PubSub.publish(wsCode.SERVER_PERFORMANCE, data.data);
  break;
```

### 前端组件示例

**文件路径**: `dashboard/src/views/test/ServerPerformanceTest.vue`

这是一个完整的测试页面，展示如何订阅和显示服务器性能数据：

```vue
<script setup>
import { ref, onMounted, onUnmounted } from 'vue'
import { PubSub } from '@/common/utils/PubSub'

const performanceData = ref(null)

// 订阅服务器性能数据
let subscriptionToken = null

onMounted(() => {
  subscriptionToken = PubSub.subscribe('server_performance', (msg, data) => {
    console.log('收到服务器性能数据:', data)
    performanceData.value = data
  })
})

onUnmounted(() => {
  if (subscriptionToken) {
    PubSub.unsubscribe(subscriptionToken)
  }
})
</script>
```

### 工具函数

#### 格式化字节数

```javascript
const formatBytes = (bytes, decimals = 2) => {
  if (bytes === 0) return '0 Bytes'

  const k = 1024
  const dm = decimals < 0 ? 0 : decimals
  const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB']

  const i = Math.floor(Math.log(bytes) / Math.log(k))

  return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i]
}
```

## 启动和配置

### 服务端启动

在 `server/main.py` 中已自动集成：

```python
# 启动服务器性能监控器
logger.info("启动服务器性能监控器...")
from src.monitor import get_server_monitor

server_monitor = get_server_monitor()  # 使用配置文件中的间隔
server_monitor.start()
```

### 自定义配置

#### 方法 1：修改配置文件（推荐）

在`server/src/core/config.py`中修改：

```python
# 服务器性能监控配置
SERVER_MONITOR_INTERVAL = 5  # 将间隔改为5秒
```

#### 方法 2：代码中显式指定

```python
# 显式指定间隔5秒
server_monitor = get_server_monitor(interval=5)
```

### 停止监控

在程序退出时自动停止：

```python
# 在 signal_handler 中
server_monitor.stop()
```

## 测试

### 后端测试

运行测试脚本：

```bash
cd server
python examples/server_monitor_test.py
```

这将启动一个模拟的 WebSocket 客户端，每 5 秒打印一次收到的性能数据。

### 前端测试

1. 启动后端服务器：

   ```bash
   cd server
   python main.py
   ```

2. 启动前端开发服务器：

   ```bash
   cd dashboard
   npm run dev
   ```

3. 在浏览器中访问测试页面：
   ```
   http://localhost:5173/test/server-performance
   ```

## 性能考虑

1. **采集间隔**: 默认 10 秒适合大多数场景，避免过于频繁的系统调用
2. **线程安全**: 使用独立的守护线程，不影响主程序运行
3. **异常处理**: 所有数据采集都有异常捕获，单个指标失败不影响其他指标
4. **网络速率计算**: 基于两次采集的差值计算，首次采集速率为 0
5. **虚拟接口过滤**: 自动过滤回环和虚拟网络接口，减少无用数据

## 依赖库

- **psutil**: 跨平台的系统和进程监控库
- **tornado**: WebSocket 通信框架
- Python 标准库: `threading`, `time`, `json`

## 扩展建议

1. **历史数据存储**: 将性能数据保存到数据库，支持历史查询和趋势分析
2. **告警机制**: 当 CPU、内存等指标超过阈值时发送告警
3. **可视化图表**: 使用 ECharts 等图表库展示实时曲线
4. **多服务器支持**: 扩展为支持监控多台服务器
5. **自定义指标**: 添加应用级别的性能指标（如数据库连接数、请求处理速度等）

## 故障排查

### 问题 1: 收不到性能数据

**可能原因**:

- WebSocket 连接未建立
- 监控线程未启动
- 前端未正确订阅消息

**解决方法**:

1. 检查浏览器控制台的 WebSocket 连接状态
2. 查看服务端日志，确认监控器已启动
3. 确认前端已使用`PubSub.subscribe`订阅

### 问题 2: 网络速率始终为 0

**可能原因**:

- 首次采集时速率为 0（正常）
- 网络接口被识别为虚拟接口

**解决方法**:

- 等待至少一个采集周期（默认 10 秒）
- 检查`_is_virtual_or_loopback_interface`方法是否误判

### 问题 3: 某些指标显示为"unknown"

**可能原因**:

- 操作系统不支持该指标（如 Windows 不支持 load_average）
- 权限不足无法读取某些系统信息

**解决方法**:

- 检查操作系统兼容性
- 使用管理员权限运行服务端程序

## 许可证

本功能遵循项目主许可证。
